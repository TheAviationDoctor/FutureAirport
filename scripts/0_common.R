# ==============================================================================
#    NAME: scripts/0_common.R
#   INPUT: None
# ACTIONS: Set common settings used across the scripts
#  OUTPUT: Set of global variables loaded into R's environment
# ==============================================================================

# ==============================================================================
# 0 Directory locations
# ==============================================================================

d <- list(
  "cal" = "data/cal", # Calibrated takeoff performance data
  "cli" = "data/cli", # Climate data in NetCDF format
  "log" = "logs",     # Log files
  "plt" = "plots"     # Plots generated by R
)

# ==============================================================================
# 1 File locations
# ==============================================================================

f <- list(
  "act" = "data/aircraft.csv",    # Aircraft data from Sun et al. (2020)
  "cal" = "data/calibration.csv", # Calibration inputs
  "net" = "data/netcdf.csv",      # List of NetCDF files from the ESGF
  "geo" = "data/geolocation.csv", # Airport coordinates from OurAirports.com
  "out" = "outfile.log",          # Log file for the scripts that require one
  "rwy" = "data/runways.csv",     # Runways and TODA from Lufthansa Systems
  "tra" = "data/traffic.csv"      # 2019 traffic by airport from IATA
)

# ==============================================================================
# 2 Database parameters
# ==============================================================================

db <- list(
  "cnf" = ".my.cnf", # File that contains the database connection parameters
  "grp" = "phd",     # Group name within the cnf file
  "act" = "act",     # Aircraft characteristics for the takeoff simulation
  "cal" = "cal",     # Calibration data
  "cli" = "cli",     # Climate data post-transformation
  "imp" = "imp",     # Climate data imported from the NetCDF files
  "pop" = "pop",     # Population and sample airports
  "tko" = "tko",     # Takeoff performance calculation outputs
  "idx" = "idx"      # Index name
)

# ==============================================================================
# 3 Takeoff simulation parameters
# ==============================================================================

sim <- list(
  # Natural constants
  "ft_to_m"     = .3048,       # Number of m in one ft
  "g"           = 9.806665,    # Gravitational acceleration constant in m/s²
  "gamma"       = 1.401,       # Adiabatic index for dry air
  "ps_isa"      = 101325L,     # Air pressure in Pa at sea level under ISA
  "Rd"          = 287.058,     # Specific gas constant for dry air in J/(kg·K)
  # Model settings
  "climb_angle" = 7.7,         # Average climb angle to screen height
  "int"         = 10L,         # Model resolution (integration steps)
  "mu"          = .02,         # Friction coefficient for dry concrete/asphalt
  "scrn_hght"   = 35L,         # Minimum screen height above terrain
  "theta"       = 0L,          # Runway slope in °
  "tod_mul"     = 1.15,        # Regulatory takeoff distance multiplier
  "vs_to_vlof"  = 1.1,         # Safety factor from stall speed to liftoff speed
  # Calibration settings
  "act_cal"     = c("A20n", "A359", "B39m", "B789"), # Aircraft to calibrate
  "clmax_range" = c(0L, 3L),   # Range of cL inputs passed to the optimizer
  "optim_tol"   = 10^-3,       # Optimizer tolerance
  # Simulation settings
  "act_sim"     = c("A20n", "A359", "B39m", "B789"), # Aircraft to simulate
  "crs"         = 23L,         # Number of cores to use for parallel processing
  "pax_mass"    = 87L,         # Average adult pax weight (Filippone, p. 52)
  "pop_thr"     = 10^6,        # Minimum passenger traffic for airport selection
  "thrst_incr"  = 1L,          # Amount of thrust increase at each iteration
  "thrst_start" = 25L          # Amount of thrust reduction to start with
)

# ==============================================================================
# 4 Common functions
# ==============================================================================

# ==============================================================================
# 4.1 Function to distribute a computational task across cores
# crs = number of cores to use in the cluster
# lib = libraries required by each core
# lst = list to be distributed across cores
# fun = function to be applied to each list item
# ==============================================================================

fn_par_lapply <- function(crs, pkg, lst, fun){

  # Set the log file to the name of the function being passed
  log <- paste("logs", "/", substitute(fun), ".log", sep = "")

  # Clear the log file in case it is not empty
  close(file(description = log, open = "w"))

  # Build the cluster of workers
  cl <- parallel::makeCluster(spec = crs, outfile = log)

  # Have each worker load the required packages
  parallel::clusterCall(
    cl = cl,
    fun = function() {
      suppressMessages(lapply(X = pkg, FUN = require, character.only = TRUE))
    }
  )

  # Pass all global variables to each worker
  parallel::clusterExport(cl = cl, varlist = ls(.GlobalEnv))

  # Distribute the task across the workers
  parallel::parLapply(cl = cl, X = lst, fun = fun)

  # Shut down the workers
  parallel::stopCluster(cl = cl)

}

# EOF
